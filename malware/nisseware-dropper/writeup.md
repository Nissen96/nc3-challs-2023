# Writeup

I [Nisseware: Exfiltration](../nisseware-exfiltration/) fik vi trukket C2-klienten `client.exe` ud af netv칝rkstrafikken og reverset den nok til at se, at al kommunikation foreg친r over websockets, krypteret med `RC4`. Vi fandt RC4-n칮glen `"n1ss3b4nd3ns_n1ss3w4r3"` og fik dekrypteret al kommunikation automatisk. Her s친 vi, at en lang r칝kke commands var blevet k칮rt og filer blevet eksfiltreret, men en fil blev ogs친 hentet *ned* p친 forurettedes maskine og k칮rt:

```
DOWNLOAD: C:\Users\Alf\Desktop\AntiVirusInstaller.exe (status 0 - File download successful)
CMD: &C:\Users\Alf\Desktop\AntiVirusInstaller.exe (status 0)
```

Alternativt er du m친ske g친et OSINT vejen f칮rst og har i [Nisseware: Infrastructure](../nisseware-infrastructure/) f친et fuld `root` adgang til `N1ss3b4nd3n`s server.
Gruppen har naturligvis deres programmer liggende p친 deres server, og samme fil kan her findes ukrypteret i `/root/nisseware/AntiVirusInstaller.exe`.

Filen er med al sandsynlighed selve ransomwaren, og umiddelbart pr칮ver `N1ss3b4nd3n` at skjule den ved at navngive den som en antivirus installer.
Uanset hvad skal programmet analyseres, s친 vi kan vurdere, hvordan det fungerer, om det har en persistancemekanisme, og om en fejl i ransomwaren g칮r det muligt at dekryptere forurettedes filer.

Der er en r칝kke forskellige m친der at g친 til opgaven p친 - vi vil f칮rst lige lave en smule dynamisk analyse (mest for sjov og illustration) og derefter g친 mere statisk til v칝rks.

### Dynamisk Analyse

Er man p친 en Windows lab VM, kan man fors칮ge at k칮re ransomwaren og se, hvad der sker - man vil f친 en konsol, der sp칮rger om et krypteringspassword, men programmet er defanged og k칮rer derefter kun under meget specifikke omst칝ndigheder, s친 det vil i stedet lukke, og dropperen sletter sig selv. F친r man sat en VM op, der matcher kriterierne, vil den kryptere filerne i en r칝kke mapper og ransomnoten popper frem med et genereret ID.

Til en indledende dynamisk analyse er programmet [Process Monitor (procmon)](https://learn.microsoft.com/en-us/sysinternals/downloads/procmon) rigtig godt. Det er lavet af Microsoft selv og er en del af deres `SysInternals` suite. Programmet monitorerer alle k칮rende processer og alle operationer, de foretager sig inden for en r칝kke kategorier, bl.a. aktivitet i filsystemet, registreringsdatabasen og netv칝rk. F칮rste gang man k칮rer v칝rkt칮jet, bliver man nok overrasket over, *hvor* mange ting, der konstant sker i baggrunden p친 ens maskine - p친 f친 sekunder kan der v칝re genereret millioner af events, s친 det er vigtigt at filtrere outputtet med de indbyggede filtre.

K칮rer man `procmon` samtidig med, at dropperen igangs칝ttes, vil der v칝re nogle interessante ting at bide m칝rke i.
Vi kan s칝tte et filter p친 `Process Name is AntiVirusInstaller.exe` og `Operation is Create File`, for at se, hvilke filer dropperen skriver:

![procmon under k칮rsel af dropper](img/procmon.png)

Her ses, at der genereres en r칝kke filer i den midlertidige mappe `C:\Users\User\AppData\Local\Temp\7ZipSFX.000`, bl.a. `AntiVirusInstaller.msi`, `7za.exe`, `conhost.exe`, `conhost.runtimeconfig.json` og vigtigst `flag.txt`! Hopper man til temp mappen vil man dog nu se, at filerne er slettet igen, og k칮res dropperen p친 ny, vil man maksimalt kunne spotte de nye filer et splitsekund, f칮r de igen er slettet.

Her kan man fx fors칮ge at k칮re dropperen i en debugger og kun steppe indtil det punkt, hvor filerne er skrevet, men det vil nok v칝re sv칝rt og tr칝ls at finde frem til.
En lidt... speciel... l칮sning p친 problemet er at lave et Python script, der i et evigt loop tjekker, om `flag.txt` eksisterer p친 den sti og l칝ser indholdet. Den vil sagtens kunne n친 at printe flaget, f칮r filen er slettet, meeen det kan ikke anbefales i praksis - lad os fors칮ge en lidt mere p친lidelig metode og foretage en statisk analyse.

### Statisk Analyse

Det er altid fornuftigt at starte med en helt basal statisk analyse og lige k칮re `file` og `strings` (eller [floss](https://github.com/mandiant/flare-floss)) p친 maskinen (ogs친 f칮r en evt. dynamisk tilgang):

```console
$ file AntiVirusInstaller.exe
AntiVirusInstaller.exe: PE32 executable (GUI) Intel 80386, for MS Windows, 4 sections
```

Alts친 umiddelbart bare en almindelig 32-bit Portable Executable, lad os se om `strings` giver os mere!
V칝r opm칝rksom p친, at en del strenge i Windows er encoded som UTF-16-LE, s친 det er altid vigtigt p친 `.exe`-filer b친de at k칮re `strings` og `strings -el`, der kigger efter strenge med den encoding. Her ses et udpluk af interessante strings fra begge udgaver:

```console
$ strings -n 8 AntiVirusInstaller.exe
...
7z SFX: 
7z SFX: warning
...
SFX module - Copyright (c) 2005-2012 Oleg Scherbakov
        1.6.0 develop [x86] build 2712 (December 30, 2012)
7-Zip archiver - Copyright (c) 1999-2011 Igor Pavlov
        9.22 beta (April 18, 2011)
...
;!@Install@!UTF-8!
GUIMode="2"
GUIFlags="2+512+8192"
MiscFlags="1+2"
SelfDelete="1"
RunProgram="hidcon:7za.exe x -y -p78675132787383836978 AntiVirusInstaller.msi"
RunProgram="dotnet conhost.exe --delete-original"
;This SFX archive was created with 7z SFX Builder v2.1. (http://sourceforge.net/projects/s-zipsfxbuilder/)
;!@InstallEnd@!7z
...
```

```console
$ strings -el -n 8 AntiVirusInstaller.exe
...
SfxString%d
...
RunProgram
AutoInstall
ExecuteFile
...
Oleg N. Scherbakov
7z Setup SFX (x86)
...
7ZSfxMod
...
7ZSfxMod_x86.exe
```

Utroligt mange strings n칝vner her `7-Zip` og rigtig mange gange n칝vnes `SFX` - kender man ikke til det format, er det klart [v칝rd at sl친 op](https://7-zip.opensource.jp/chm/cmdline/switches/sfx.htm)!
`7z SFX` er et modul til at generere et "self extrating archive", dvs. en form for `7z`-arkiv, der er pakket som en eksekverbar fil, der kan udpakke sig selv.
Tanken er, at hvis man har et program, der er fordelt p친 flere filer, kan du pakke dem i et arkiv og i stedet for blot at udlevere arkivet til modtageren, kan de f친 en rigtig eksekverbar fil som normalt, der fungerer som installer.

SFX-filen best친r af tre dele:

1. Et SFX modul (der findes forskellige afh칝ngig af fx GUI / CLI mode)
2. En config fil
3. En 7z-fil i bunden med de reelle filer

Disse concatenates bare til 칠n samlet fil, typisk med en kommando i denne stil, hvis det g칮res manuelt:

```console
$ copy /b 7zSD.sfx + config.txt + archive.7z archive.exe
```

SFX modulet extracter indholdet af 7z-filen til en midlertidig mappe (medmindre andet er specificeret i config filen).
Herefter definerer config filen, hvad installeren skal g칮re og hvordan.
Config skal starte med `;!@Install@!UTF-8!` og slutte med `;!@InstallEnd@!7z`, s친 faktisk har vi allerede f친et extracted denne i vores `strings` output:

```
;!@Install@!UTF-8!
GUIMode="2"
GUIFlags="2+512+8192"
MiscFlags="1+2"
SelfDelete="1"
RunProgram="hidcon:7za.exe x -y -p78675132787383836978 AntiVirusInstaller.msi"
RunProgram="dotnet conhost.exe --delete-original"
;This SFX archive was created with 7z SFX Builder v2.1. (http://sourceforge.net/projects/s-zipsfxbuilder/)
;!@InstallEnd@!7z
```

I bunden ses en kommentar, der viser, at filen er blevet genereret med `7z SFX Builder v2.1`:

![7zip SFX Builder - hovedmenu](img/sfx-builder.png)

Her ses, at `GUIMode="2"` betyder, at alle GUI vinduer skal skjules, `SelfDelete="1"` at SFX-filen sletter sig selv efter afvikling, og s친 er der sat en r칝kke `GUIFlags` og `MiscFlags`, hvis betydning kan ses her:

![7zip SFX Builder - GUI og Misc flag](img/sfx-flags.png)

Det er alts친 alle sammen flag, der g칮r, at programmet laver s친 lidt st칮j som muligt og ikke kr칝ver nogen form for brugerinteraktion.
De to `RunProgram` linjer definerer, hvad installeren skal k칮re, n친r filerne fra den ydre `7z`-fil er extracted. Den f칮rste har `hidcon` sat, hvilket st친r for `hide console`, s친 intet konsolvindue popper op.

F칮r vi gennemg친r, hvad installeren k칮rer af kommandoer, giver det god mening at f친 extracted 7z-filen fra bunden og se, hvad den indeholder.
Et fors칮g p친 at extracte med `binwalk` eller `foremost` viser, at det ikke er helt s친 ligetil, men man kan klart lave manuel extraction af alt indhold, der kommer efter config filen.

Et lidt mere elegant alternativ er dog bare at k칮re `7z` p친 filen! 7-zip kr칝ver ikke, at selve 7z-dataen ligger i toppen af en fil, men leder selv efter headeren:

```console
$ 7z x AntiVirusInstaller.exe

Extracting archive: AntiVirusInstaller.exe

Files: 2
Size:       1306796
Compressed: 580444
```

Dette extracter to filer: `7za.exe` og `AntiVirusInstaller.msi`.
Efter den dynamiske analyse kan disse filnavne ikke komme som en overraskelse, men vi har nu ogs친 extracted dem med en p친lidelig metode.

`7za.exe` er en self-contained version af `7z`, som kan bruges, uanset om brugeren har 7-zip installeret lokalt.
Den anden fil ligner umiddelbart en installer, da den p친st친r at v칝re en `msi`-fil - men hvad siger `file`?

```console
$ file AntiVirusInstaller.msi
AntiVirusInstaller.msi: 7-zip archive data, version 0.4
```

Aha! Det er faktisk bare et 7-zip arkiv i forkl칝dning. Vi kan pr칮ve at extracte dette, men den forventer et password.
Kigger vi tilbage i vores config fil ses, at f칮rste kommando, der k칮res, er:

```
7za.exe x -y -p78675132787383836978 AntiVirusInstaller.msi
```

S친 den vedlagte self-contained 7z-extractor bruges til at extracte indholdet af `AntiVirusInstaller.msi` med password `78675132787383836978`.
Her gemmer sig et lille easter egg til den opm칝rksomme: Password er decimal ASCII encoding `78 67 51 32 78 73 83 83 69 78`, der decoder til `NC3 NISSEN` 游땔

Er man p친 Windows, kan man extracte filen med den pr칝cise kommando fra config filen, og ellers kan man bruge en installeret `7z` som normalt:

```console
$ 7z x -y -p78675132787383836978 AntiVirusInstaller.msi

Extracting archive: AntiVirusInstaller.msi

Files: 3
Size:       22695
Compressed: 14508
```

Dette giver os tre nye filer: `conhost.exe`, `conhost.runtimeconfig.json` og sidst, men ikke mindst `flag.txt`!
Vi har nu fundet frem til den faktiske ransomware, som dropperen har extractet og nu eksekverer med den anden og sidste `RunProgram`-linje i config filen:

```
dotnet conhost.exe --delete-original
```

Som tegn p친, vi nu har adgang til hjertet af programmet og som gevinst for at have foretaget en fornuftig analyse af dropperen, f친r vi nu flaget:

```console
$ cat flag.txt
NC3{s3lf_3xtr4ct1ng_p4yl04d}
```

Efterforskningen forts칝tter i [Nisseware: Encryption](../nisseware-encryption/), hvor vi skal analysere selve ransomwaren og m친ske n친 et af vores end goals: Dekryptering af forurettedes filer.

**Flag**

`NC3{s3lf_3xtr4ct1ng_p4yl04d}`
