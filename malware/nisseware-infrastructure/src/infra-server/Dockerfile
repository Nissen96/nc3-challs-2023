# Use a base image with the desired OS (e.g., Ubuntu, Debian, etc.)
FROM ubuntu:latest

# Install SSH server
RUN apt-get update &&  apt-get install -y cron file sudo vim openssh-server

# Create an SSH user
RUN useradd -m -s /bin/bash n1ss3f4r
RUN echo 'n1ss3f4r:HyphypAlleMine9R3nsdyr!' | chpasswd
RUN mkdir /var/run/sshd

# Update root password
RUN echo 'root:MegetLangtOgHemmeligtRootPassword-SomIngenSpillereGÃ¦tter24122023' | chpasswd

# User and root flag
RUN echo "NC3{N1ss3b4nd3ns_53rv3r" > /home/n1ss3f4r/flag_user.txt
RUN echo "_1nf1ltr3r3t_g00d_j0b!}" > /root/flag_root.txt

# Populate user and root folders with a few relevant files
COPY server_files/todo.txt /home/n1ss3f4r
COPY server_files/2023-Q3-regnskab.xlsm /home/n1ss3f4r
COPY server_files/obfuscated-vbs-loader.vbs /home/n1ss3f4r/loader.vbs
RUN mkdir /home/n1ss3f4r/payloads
COPY server_files/payloads /home/n1ss3f4r/payloads
RUN mkdir /root/c2
RUN mkdir /root/c2/upload
COPY server_files/server /root/c2
COPY server_files/legetojros /root/c2/upload
RUN mkdir /root/nisseware
COPY server_files/instructions.hta /root/nisseware
COPY server_files/AntiVirusInstaller.exe /root/nisseware

# Add scripts to schedule
RUN mkdir /usr/scheduled
RUN chmod 0777 /usr/scheduled
COPY server_files/delete_logs.sh /usr/scheduled
COPY server_files/fetch_new_payments.sh /usr/scheduled
RUN mkdir /data
COPY server_files/payments.txt /data
RUN chmod 0700 /usr/scheduled/*

# Setup cronjob to run all scripts in dir every minute (as root)
COPY server_files/run_all.sh /root
RUN chmod 0744 /root/run_all.sh
COPY server_files/cronjob /etc/cron.d/run_scripts
RUN chmod 0644 /etc/cron.d/run_scripts
RUN crontab /etc/cron.d/run_scripts 

# Fix pam issues with cron job
RUN sed -i '/session    required     pam_loginuid.so/c\#session    required   pam_loginuid.so' /etc/pam.d/cron

# Add script to run both cron and sshd
COPY server_files/startup.sh /root
RUN chmod +x /root/startup.sh

# Expose the SSH port
EXPOSE 22

# Start SSH server on container startup
CMD /root/startup.sh
