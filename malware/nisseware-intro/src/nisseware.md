# Nisseware

## Historie

Legetøjsvirksomheden `Legetøj"Я"Os` er ramt af et hacking angreb fra den nye threat actor `N1ss3b4nd3n`.
Virksomheden er inficeret via et phishingangreb, hvorved hackerne fik adgang til en workstation og begyndte at rode rundt.
Gruppen har eksfiltreret og slettet forretningshemmeligheder og herefter afviklet deres ransomware `Nisseware` og krypteret mange vigtige dokumenter. De kræver en løsesum for at dekryptere dataen og for ikke at leake den.

## Detaljer

`N1ss3b4nd3n` har sendt en phishing mail med maldoc, et Excel regneark med obfuskeret VBA, som en medarbejder har kørt.
Koden decoder et obfuskeret powershell script, der henter en adresse ned fra en fil på GitHub (så adressen nemt kan udskiftes uden at ændre vba). Via denne adresse hentes C2 client software, som afvikles og forbinder til gruppens C2-server.

Klienten genererer og sender et ID til C2-serveren og venter på commands.
Alle requests og responses i begge retninger er encrypted med RC4 (hardcoded key).

Commands:
	1. `cmd`: Kør commands og få svar
	2. `upload`: Upload filer fra client til server
	3. `download`: Download filer fra server til client
	4. `kill`: Dræb forbindelsen

Herudover sendes hvert 5. minut en `alive` pakke, for at fastholde forbindelsen.

`N1ss3b4nd3n` kører først nogle simple commands for at enumerate og indsamle info om systemet.
Herefter uploades og slettes en række dokumenter med kritiske forretningshemmeligheder.
Sidst downloades ransomwaren `Nisseware` fra en anden server og eksekveres.

`Nisseware` er skrevet i C# og pakket i en self-extracting 7-zip SFX fil, der er sat til at self-delete.
Ransomwaren encrypter alt relevant på maskinen med AES med samme key (genereret på baggrund af ukendt password).
Der bruges CTR mode, så man kan bryde krypteringen med et known plaintext attack. Specifikt udleveres en krypteret installationsfil fra `7z`, som kan findes dekrypteret på nettet - URL kan findes i RAM.

Til sidst genereres et ID, som indsættes i ransomnote, der vises automatisk på skærmen (HTA-fil).
Ransomnote indeholder instruktioner til betaling af løsesum i ETH på Goerli testnet.
Her kan offentligt på blockchainen ses indgående transaktioner fra andre ofre og det hele overføres videre til en anden konto.

Commit history i GitHub brugt til loading leaker adresser på tidligere anvendte scripts, mange på pastebin.
På gruppens pastebin kan herudover findes en offentlig medlemsliste, der leaker navne på en del af gruppens medlemmer.

`HrM0rt3ns3n` har en X/Twitter profil, der kan findes, som igen linker til Mastodon.
Her følges han af gruppens leder, `N1ss3f4r`, der også har en profil.
Der hintes mod en infosec.exchange profil med en række posts, men `n1ss3f4r` foretrækker de lidt ældre sociale netværk, og han har en Instagram, man kan finde.

På sin Instagram har han ved en fejl leaket adressen på deres C2 server samt en email med credentials.
Disse kan bruges til at skaffe sig adgang og infiltrere deres server.
Her køres et cronjob, der kører alle scripts som `root` i en specifik mappe - her kan en reverse shell e.l. skrives ind og give root access til serveren.

**End goals:**

1. Dekrypter offerets filer
2. Find spor og info om gruppen, der kan bruges til retsforfølgelse
3. Find pengespor, så løsesummer potentielt kan beslaglægges
4. Infiltrer og disrupt gruppen: Skaf fuld adgang til deres infrastruktur, så stjålet data kan fjernes og serveren tages ned

## Handout
- Phishing email
- 3 encryptede filer (billede med flag og to andre)
- Ransomnote
- RAM dump
- Netværkslogs

## Challenges
1. Phishing:
	- Hent maldoc ud af mail
	- Extract VBA kode og deobfuscate
	- Deobfuscate PowerShell loader
	- Flag er key brugt til videre deobfuscation
2. Loading:
	- Find GitHub link i deobfuscated PowerShell loader eller i pcap
	- Tjek commit history og find tidligere anvendte scripts fra pastebin
	- Ét af disse er obfuskeret og krypteret PowerShell
	- Dekrypteret script er simpelt PowerShell, der henter og eksekvererer en binary
	- Flag er token parameter i URLen
3. Exfiltration:
	- Find hentet EXE i netværstrafik - unstripped go binary
	- Find `main.main` og analyser koden overfladisk
	- Mest interessante er de mulige commands og at al trafik krypteres med RC4
	- Find hardcoded RC4 key i binary så trafik kan decodes
	- Se at der er eksfiltreret data
	- Extract og decrypt PDF med flag fra PCAP
4. Dropper:
	- Find og extract hvor ransomware hentes ned i PCAP
	- Analyser binary og se det er 7z-SFX fil
    	- Extract plaintext config fil
    	- Extract 7z fil og udpak filer
        	- Indeholder en krypteret 7z skjult som msi og en self-contained 7z binary
	- Config fil viser kørte commands inkl. password til udpakning af msi
	- Flag (og dotnet ransomware) er i udpakket msi
5. Encryption:
	- Analyser dotnet ransomware med fx ILSpy eller dnSpy
	- Alle filer er encrypted med samme key med en manuel implementering af CTR-mode
	- Fælles keystream kan derfor recovers med known plaintext attack - XOR ciphertext med known plaintext
		- Angrebet kan verificeres med gætværk, men kræver en originalfil for fuld decryption
		- Kan i princippet løses uden reversing af ransomwaren med gætværk, men er meget nemmere efter
	- En af de tre udleverede krypterede filer er downloadet for nylig (7z installer)
	- URL på denne kan findes i RAM (eller gæt det er nyeste 64-bit udgave til Windows)
	- Hent original installer og XOR med krypteret udgave for at få keystream
	- Dekrypter de to resterende filer ved XOR med keystream
	- Flag står visuelt i JPEG billede af et blueprint på legetøj
6. Ransom:
	- Ransomnote indeholder ETH kryptoadresse på Goerli testnet
	- Gruppen har modtaget transaktioner fra andre ofre og sender alt videre til en samlet konto
	- Flag kan findes på blockchain under en transaktion til den samlede konto
7. OSINT:
	- Pastebin links blev fundet i `Nisseware: Loading`
	- Fjernes `raw` fra URL kan de original pastebin entries ses, alle postet under brugeren `N1ss3b4nd3n`
	- Klikkes på dennes profil ses en enkelt offentlig note med info om gruppens medlemmer (udover leder)
	- De fleste har intet relevant, men `HrM0rt3ns3n` har en X/Twitter account
	- Denne henviser til Mastodon, og her findes første halvdel af flag, base85 encoded
	- Mastodon kontoren har en enkelt følger: `N1ss3f4r`, lederen af `N1ss3b4nd3n`
	- `N1ss3far` har selv en Mastodon, men henviser specifikt til infosec.exchange
	- På denne konto findes anden halvdel af flaget i base85
8.  Infrastructure (+ OSINT):
	- `N1ss3f4r` henviser til de lidt ældre mere velkendte netværk og man kan finde en Instagram konto med samme brugernavn
	- Har en række forskellige posts, inklusiv et billede af sin skærm
	- Dette leaker en SSH session, der viser server name og username, samt en mail fra `HrM0rt3nsen` med password.
	- Log ind med SSH (sat op dynamisk i Haaukins): `ssh n1ss3f4r@n1ss3b4nd3n.jul` med password `HyphypAlleMine9R3nsdyr!`
	- Her kan findes en række filer fra angrebet og et par personlige filer
	- Første halvdel af flag ligger i `flag_user.txt`
	- Tjekkes cron jobs ses et med navnet `run_scripts`, der kører scriptet `/root/run_all.sh` med argument `/usr/scheduled` hvert 5. minut
	- Det tyder på, at alle scripts i den mappe køres som root
	- I mappen findes `fetch_new_payments.sh` og `delete_logs.sh`, der begge har root perms
	- Sæt en lokal listener op og skriv et nyt script med en reverse shell
	- Inden for 5 minutter køres dette script som root, og man har root shell
	- Anden halvdel af flag ligger i `flag_root.txt`

## Flag

1. Phishing (i pwsh loader som key): `NC3{t1d_t1l_s3cur1ty_4w4r3n3ss_kur5u5}`
2. Loading (i obfuskeret pastebin payload): `NC3{dyn4m1sk_p4yl04d_0pd4t3r1ng}`
3. Exfiltration (i PDF fra PCAP): `NC3{k0mpr0m1tt3r3nd3_f0rr3tn1ng5h3mm3l1gh3d3r}`
4. Dropper (7z-SFX i krypteret "MSI"): `NC3{s3lf_3xtr4ct1ng_p4yl04d}`
5. Encryption (AES-CTR, i legetøjsblueprint JPEG): `NC3{d0n7_r0ll_y0ur_0wn_cryp70}`
6. Ransom (på Goerli testnet): `NC3{cryp70_3r_4n0nym_b3t4l1ng5f0rm_r1gh7?}`
7. OSINT (Mastodon og infosec.exchange): `NC3{f0ll0w_7h3_wh1t3_w4bb1t}`
8. Infrastructure (Instagram leak og simpel b2r): `NC3{n1ss3rn3s_53rv3r_1nf1ltr3r3t_g00d_j0b!}`


## Personaer

- Virksomhed: `Legetøj"Я"Os`
  - `Alf E. Nissen`
    - Privat mail: `legetojsalf@proton.me`
    - Virksomhedsmail: `aen@legetojros.dk`
- Ransomgruppe: `N1ss3b4nd3n`
  - `Hr. M0rt3ns3n`
    - Mail: `m0rt3ns3n@proton.me`
    - X/Twitter: https://twitter.com/HrM0rt3ns3n
    - Mastodon: https://mastodon.social/@M0rt3ns3n
  - `N1ss3f4r`
  	- Mail: `n1ss3f4r@proton.me`
  	- Mastodon: https://mastodon.social/@n1ss3f4r
  	- infosec.exchange: https://infosec.exchange/@n1ss3f4r
  	- Instagram: https://www.instagram.com/n1ss3f4r/
  - Phishing profil
    - `Jytte Andersen`
    - Mail: `regnskab@legetojr0s.dk`
      - Tæt på "rigtig" virksomhedsmail, bruger `0` et enkelt sted
- Pastebin: https://pastebin.com/u/N1ss3b4nd3n
- GitHub: https://github.com/N1ss3b4nd3n
  - Link file: https://raw.githubusercontent.com/N1ss3b4nd3n/N1ss3b4nd3n/main/README.md

## Overvejelser

Visse elementer/filer vil muligvis kunne findes i både PCAP (RC4 encrypted) og RAM - er fint hvis muligt, men det meste er nok kun i PCAP. RAM er ikke strengt nødvendigt, men skal bruges til URL på 7z installer til known plaintext attack for ikke at gætte sig frem.

Mange challs kan løses separat, men i flere er det en fordel/hjælp, hvis en foregående er løst (og er egentlig tanken)

1. Helt separat, starten på exploit
2. Kan løses fra PCAP alene, men kan bekræftes/identificeres med viden fra `(1)`. Herudover ligger det relevante script på C2-serveren, hvis man får løst hele OSINT og infrastructure delen først, det er dog noget nemmere at finde direkte fra GitHub.
3. Kan løses fra PCAP alene, men er igen nemmere at identificere den hentede software med viden fra `(2)`. Skal kræve reversing af Go binary, hverken RC4 key eller fuld ukrypteret PDF må kunne findes i RAM
4. Kræver key fra `(3)` at finde og dekrypteret downloadet ransomware - MEN, løses hele OSINT og infrastructure delen først `(7-8)`, ligger ransomware i `/root` mappen, så to forskellige opgaver låser op for denne.
5. Tiltænkt at kræve extraction af ransomware fra 7z SFX fil, altså at `(4)` er løst
   - I princippet kan man lave lidt standard analyse på de krypterede filer og XOR hver med deres kendte file headers og se, man får samme keystream ud og derfra gætte sig til known plaintext attack
   - Så opgaven kan reelt løses uden overhovedet at få fat på ransomwaren, men vil være lidt guessy og er ikke meningen - måske enkelte lykkes med dette
6. Helt separat
7. Kræver GitHub link, man finder i `(2)`, men kræver ikke reelt en løsning på `(2)` og er helt separat derfra
   - Der ligger posts på især `N1ss3f4r`s infosec.exchange profil, der peger på hans/deres indblanding i angreb
   - Enkelte af disse indeholder små hints til visse opgaver - bl.a. at ETH er sporbart og at block cipher modes er relevant
8. Kræver `(7)` som minimum delvist løst, da alle nok finder infosec.exchange kontoen før Instagram
   - Initial access låser i princippet mere op for `(2)`, da pastebin payloads ligger her, men det virker ikke super sandsynligt, at nogle har fundet GitHub og pastebin og er kommet videre til OSINT og serveren uden først at finde andre pastebin links i commit history.
   - Fuld root access låser op for `(4-5)`, da ransomware ligger ukrypteret i `/root`
